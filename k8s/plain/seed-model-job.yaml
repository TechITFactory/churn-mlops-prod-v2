apiVersion: batch/v1
kind: Job
metadata:
  name: churn-seed-model
  namespace: churn-mlops
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never

      initContainers:
        - name: init-dirs
          image: busybox:1.36
          command: ["sh", "-c", "mkdir -p /pvc/data /pvc/artifacts"]
          volumeMounts:
            - name: mlops-storage
              mountPath: /pvc

      containers:
        - name: seed
          image: techitfactory/churn-ml:0.1.4
          imagePullPolicy: IfNotPresent
          env:
            - name: CHURN_MLOPS_CONFIG
              value: /app/config/config.yaml
          command: ["sh", "-c"]
          args:
            - |
              set -e
              ./scripts/generate_data.sh
              ./scripts/validate_data.sh
              ./scripts/prepare_data.sh
              ./scripts/build_features.sh
              ./scripts/build_labels.sh
              ./scripts/build_training_set.sh
              ./scripts/train_baseline.sh
              ./scripts/promote_model.sh

          volumeMounts:
            - name: mlops-storage
              mountPath: /app/data
              subPath: data
            - name: mlops-storage
              mountPath: /app/artifacts
              subPath: artifacts
            - name: config
              mountPath: /app/config/config.yaml
              subPath: config.yaml

      volumes:
        - name: mlops-storage
          persistentVolumeClaim:
            claimName: churn-mlops-pvc
        - name: config
          configMap:
            name: churn-mlops-config
